---
- name: Configure RDMA and ECN
  hosts: localhost
  gather_facts: yes
  become: yes
  become_method: su
  tasks:
    - name: Check if sudo is available
      command: which sudo
      register: sudo_check
      ignore_errors: yes
      changed_when: false

    - name: Install sudo if not present
      package:
        name: sudo
        state: present
      when: sudo_check.rc != 0

    - name: Get MST status
      shell: mst status -v
      register: mst_output
      become: yes

    - name: Parse RDMA and NET devices
      set_fact:
        RDMAs: "{{ RDMAs | default([]) + [item.split()[3]] }}"
        NETs: "{{ NETs | default([]) + [item.split()[4] | regex_replace('^net-', '')] }}"
      with_items: "{{ mst_output.stdout_lines }}"
      when: "'DEVICE_TYPE' in item or (item.split()[3] and item.split()[4])"

    - name: Enable ECN globally
      sysctl:
        name: net.ipv4.tcp_ecn
        value: 1
        state: present

    - name: Configure ECN for NET devices - Enable ECN for class 3
      command: echo 1 > /sys/class/net/{{ item }}/ecn/roce_np/enable/3
      loop: "{{ NETs }}"

    - name: Configure ECN for NET devices - Enable CNP L2 egress priority to 7
      command: echo 7 > /sys/class/net/{{ item }}/ecn/roce_np/cnp_802p_prio
      loop: "{{ NETs }}"

    - name: Configure ECN for NET devices - Map CNP to DSCP 48
      command: echo 48 > /sys/class/net/{{ item }}/ecn/roce_np/cnp_dscp
      loop: "{{ NETs }}"

    - name: Configure ECN for NET devices - Map PFC to priority 3
      command: mlnx_qos -i {{ item }} --trust=dscp --pfc 0,0,0,1,0,0,0,0
      loop: "{{ NETs }}"
